


<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="We can make changes to the Linux kernel and compile it to make out a custom copy. For that, I have written a detailed tutorial for you. In this post, You'll also learn how you can write your custom man page for your custom syscall.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=e449e7a970f108afba3bada7edebb409295e72db">
    <link rel="stylesheet" href="/assets/styles/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/styles/customFile.css" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="alternate" type="application/atom+xml" title="ali@pwnworld$" href="/feed.xml">

    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'G-HSTC4ENYHY', 'auto');
    ga('send', 'pageview');
  </script>



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Linux Kernel Compilation and Adding a Custom System Call | ali@pwnworld$</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Linux Kernel Compilation and Adding a Custom System Call" />
<meta name="author" content="Ali Raza" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="We can make changes to the Linux kernel and compile it to make out a custom copy. For that, I have written a detailed tutorial for you. In this post, Youâ€™ll also learn how you can write your custom man page for your custom syscall." />
<meta property="og:description" content="We can make changes to the Linux kernel and compile it to make out a custom copy. For that, I have written a detailed tutorial for you. In this post, Youâ€™ll also learn how you can write your custom man page for your custom syscall." />
<link rel="canonical" href="http://localhost:4000/2022/04/13/Linux-Kernel-Compilation.html" />
<meta property="og:url" content="http://localhost:4000/2022/04/13/Linux-Kernel-Compilation.html" />
<meta property="og:site_name" content="ali@pwnworld$" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-13T00:00:00+05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Linux Kernel Compilation and Adding a Custom System Call" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2022/04/13/Linux-Kernel-Compilation.html","headline":"Linux Kernel Compilation and Adding a Custom System Call","dateModified":"2022-04-13T00:00:00+05:00","datePublished":"2022-04-13T00:00:00+05:00","author":{"@type":"Person","name":"Ali Raza"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2022/04/13/Linux-Kernel-Compilation.html"},"description":"We can make changes to the Linux kernel and compile it to make out a custom copy. For that, I have written a detailed tutorial for you. In this post, Youâ€™ll also learn how you can write your custom man page for your custom syscall.","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Adsense Auto Ads Code -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9885194547171466"
     crossorigin="anonymous"></script>
  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>ali@pwnworld$</h1>
        </a>
        <h2>A Computer Science student interested in Kernel Security Exploitation.</h2>

        <section >
        <a href="https://www.twitter.com/alirazamumtaz" title="Twitter"><i class="fa fa-twitter-square fa-lg" aria-hidden="true"></i></a>
          <a href="https://www.github.com/alirazamumtaz" title="Github"><i class="fa fa-github-square fa-lg" aria-hidden="true"></i></a>
          <a href="https://www.linkedin.com/in/alirazamumtaz" title="linkedin"><i class="fa fa-linkedin-square fa-lg" aria-hidden="true"></i></a>
          <a  href="/feed.xml" target="_blank"><i class="fa fa-rss" aria-hidden="true"></i>
          </a>

        </section>
        <a href="/"><button type="button" class="btn btn-outline-secondary" style="margin-bottom: 10px">Home</button></a>
        <a href="/posts"><button type="button" class="btn btn-outline-secondary" style="margin-bottom: 10px">Posts</button></a>
        <!-- <a href="/disclosures"><button type="button" class="btn btn-outline-secondary" style="margin-bottom: 10px">disclosures</button></a> -->
        <a href="/archive"><button type="button" class="btn btn-outline-secondary" style="margin-bottom: 10px">Archive</button></a>

            </div>
   </header>

    <div class="container">
      <section id="main_content">
        <small>13 April 2022</small>
<h1>Linux Kernel Compilation and Adding a Custom System Call</h1>

<p class="view">by Ali Raza</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Please make sure you have a good amount of free space. As for Virtual Machines, people were having issues when they allocated only 20GB of storage space. So at least allocate 50GBs to avoid the issues.</p>

<p>Install the following packages before moving to next step:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>gcc make bc build-essential libelf-dev libssl-dev bison flex initramfs-tools git-core libncurses5-dev dwarves zstd
</code></pre></div></div>

<aside>
ðŸ’¡ In sir Arifâ€™s document, one package was missing with the name `dwarves` and `zstd`

</aside>

<p>Now you can follow these steps. First of all, weâ€™ll compile the kernel and test itâ€™s running. Then weâ€™ll add our custom system call.</p>

<h1 id="compiling-linux-kernel">Compiling Linux Kernel</h1>

<h2 id="step-1-downloading-source-code-and-extracting">Step 1: Downloading source code and extracting</h2>

<p>Download the kernel file from <a href="http://www.kernel.org/">www.kernel.org</a> i would recommend downloading Linux Kernel 5.3.7 Or above version because the method of adding system calls described here is for kernel 5.3.7 or above.</p>

<p>For simplicity you can download from this direct link (<code class="language-plaintext highlighter-rouge">Kernel 5.10.117</code>):</p>

<p><a href="https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.10.117.tar.xz">https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.10.117.tar.xz</a></p>

<p>if you are looking to download any other version, for simplicity you will need to download tarball file, as shown in the picture bellow.</p>

<p><img src="/assets/images/posts/2022-04-13-Linux-Kernel-Compilation-imgs/1.jpeg" alt="1.jpeg" /></p>

<p>When you have downloaded the archive file linux-5.x.x.tar.xz, you need to extract the file in some directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar </span>xvf linux-5.x.x.tar.xz <span class="c">#use correct file name</span>
<span class="nb">cd </span>linux-5.x.x.tar.xz
</code></pre></div></div>

<p>Now you are in the directory of kernel files you can verify by list file using <code class="language-plaintext highlighter-rouge">ls</code> command.</p>

<p><img src="/assets/images/posts/2022-04-13-Linux-Kernel-Compilation-imgs/2.png" alt="2.png" /></p>

<h2 id="step-3-configuration">Step 3: Configuration</h2>

<p>Now you need to configure your flavor of the kernel. Configuring the kernel involves selecting which features you want to build into the kernel image, which features you want to build as loadable modules, and which features you want to omit entirely. The configure process will finally create a .config script for building the kernel. The .config file contains the configuration information (which has information about the features to be installed) of the kernel to be compiled.</p>

<p>There are different methods to configure the Linux kernel, but weâ€™ll go with the old configuration of the currently running kernel. Here weâ€™ll copy the old configurations form <code class="language-plaintext highlighter-rouge">/boot/config-x.x.x-x-generic</code> and weâ€™ll create a new .config in our kernelâ€™s directory.</p>

<p>like</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> /boot/config-5.13.0-40-generic ./.config
</code></pre></div></div>

<aside>
ðŸ’¡ You may have more `config-x.x.x-x-generic` files so to check which configuration is active now use `uname -r` and then copy these versions of the generic file.

</aside>

<p>Now in this .config file, we need to make some changes.</p>

<aside>
ðŸ’¡ This step was missing in sir Arifâ€™s document.

</aside>

<ol>
  <li>Open the .config file in vim.</li>
  <li>Search for <code class="language-plaintext highlighter-rouge">CONFIG_SYSTEM_TRUSTED_KEYS</code> and assign an empty string to it (i.e, double quotes<code class="language-plaintext highlighter-rouge">""</code>)</li>
  <li>Search for <code class="language-plaintext highlighter-rouge">CONFIG_SYSTEM_REVOCATION_KEYS</code> and assign an empty string to it (i.e, double quotes<code class="language-plaintext highlighter-rouge">""</code>)</li>
</ol>

<p><img src="/assets/images/posts/2022-04-13-Linux-Kernel-Compilation-imgs/3.jpeg" alt="3.jpeg" /></p>

<ol>
  <li>Now save the file and quit. <code class="language-plaintext highlighter-rouge">:wq!</code></li>
</ol>

<p>Now run the following command to configure:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">yes</span> <span class="s1">''</span> | make oldconfig <span class="c"># it may take some time</span>
</code></pre></div></div>

<p>Till now you have made the configuration. But still, you need to distinguish your kernel from other versions. To do so, Open Makefile present in the kernelâ€™s root directory and change the variable <code class="language-plaintext highlighter-rouge">EXTRAVERSION</code> with some name like this:</p>

<p><img src="/assets/images/posts/2022-04-13-Linux-Kernel-Compilation-imgs/4.png" alt="4.png" /></p>

<p>Now to make a copy of the kernel release, run the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make kernelrelease <span class="c"># after success a kernel release will be printed like 5.10.117-arm</span>
</code></pre></div></div>

<h2 id="step-4-compiling-the-modules">Step 4: Compiling the modules</h2>

<p>Now itâ€™s time to build/compile the kernel modules.</p>

<p>To do so you can you the following commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make <span class="nt">-j</span> <span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span> bzImage <span class="c"># nproc gives the number of your system's cores. and by this command, I am using all of my system's cores to make this process faster</span>

<span class="c"># after the success of the above command, run the following command.</span>

make <span class="nt">-j</span> <span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span> modules
</code></pre></div></div>

<h2 id="step-5-installing-modules">Step 5: Installing modules</h2>

<p>Till now your kernel release has been compiled. Now to install the modules, use the following command. You need to be sudoer for the installation process.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>make <span class="nv">INSTALL_MOD_STRIP</span><span class="o">=</span>1 modules_install

<span class="c"># INSTALL_MOD_STRIP=1 will reduce the size of the modules before installing them.</span>
</code></pre></div></div>

<p>This step will take just a second and create a new directory <code class="language-plaintext highlighter-rouge">/lib/modules/5.10.117-arm/</code> and copy all the <code class="language-plaintext highlighter-rouge">.ko</code> files (modules) over there.</p>

<h2 id="step-6-installing-kernel">Step 6: Installing kernel</h2>

<p>Now run the following command to install the custom kernel.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>make <span class="nb">install</span>
</code></pre></div></div>

<p>The install section of Makefile will move the files to their destination locations mentioned in the DIR variables (in the Makefile like <code class="language-plaintext highlighter-rouge">BIN_DIR,</code> <code class="language-plaintext highlighter-rouge">MAN_DIR</code>, <code class="language-plaintext highlighter-rouge">BIN_DIR_D</code>, â€¦). Instead of using <code class="language-plaintext highlighter-rouge">mv</code> or <code class="language-plaintext highlighter-rouge">cp</code> command the install target of Makefile uses a Linux install command that not only moves files but also changes permissions to those files.</p>

<h2 id="step-6-updating-the-grub">Step 6: Updating the grub</h2>

<p>Till now your kernel has been compiled and installed. But still, we need to update the grub boot loader in order to boot our system from the custom kernel. For that, we need to increase the booting selection process in order to select our kernel. To do so open the file
<code class="language-plaintext highlighter-rouge">/etc/default/grub</code> in vim and change the <code class="language-plaintext highlighter-rouge">GRUB_TIMEOUT</code> value from 5 to 30.</p>

<p>Moreover, let the <code class="language-plaintext highlighter-rouge">GRUB_DEFAULT</code> value to 0, which means by default boot from the first entry of the kernel in the <code class="language-plaintext highlighter-rouge">/boot/grub/grub.cfg</code> file, which will be the newly installed kernel.</p>

<p>After making these changes you need to update the boot loader using the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>update-grub2
</code></pre></div></div>

<p>This will update GRUB with the new kernel. And if it is the latest kernel version then it will become the default to be loaded when rebooting. Otherwise, we need to select the kernel to run during the booting process explicitly. To open the boot loader, restart the system, during system startup hold the shift key and you will see a screen with all installed kernels.</p>

<p>Congratulations your kernel is ready to boot.</p>

<p>Restart your system in order to boot from the new kernel.</p>

<aside>
ðŸ’¡ If you have Linux OS as your host operating system and you have turned on the secure boot, then here you might get an error while booting from your new kernel. To handle that error you need to turn off the secure boot and try to boot from your new kernel.r

</aside>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl reboot
</code></pre></div></div>

<h1 id="adding-system-call">Adding system call</h1>

<p>Till now we have compiled and installed our configured Linux kernel release. Now itâ€™s time to make actual changes in the kernel source code to have the motivation that we are actually making changes to the kernel.</p>

<p>For this time weâ€™ll add only our custom hello world system call.</p>

<aside>
ðŸ’¡ Make sure that you should not have booted from your custom kernel to follow these steps.

</aside>

<h2 id="step-1-writing-the-systemcall-code-c-file">Step 1: Writing the systemcall code (<code class="language-plaintext highlighter-rouge">.c</code> file)</h2>

<ol>
  <li>Create a c file in which youâ€™ll define your system call. As for now, we are adding a just hello world system call, so use these c files.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>my_syscall <span class="c"># create this directory inside the linux source root directory</span>
<span class="nb">cd </span>my_syscall
<span class="nb">touch </span>hello_world.c
</code></pre></div></div>

<ol>
  <li>Add the following code snippet as this is your custom system call code.</li>
</ol>

<p><img src="/assets/images/posts/2022-04-13-Linux-Kernel-Compilation-imgs/5.png" alt="5.png" /></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;linux/kernel.h&gt;
#include &lt;linux/syscalls.h&gt;
</span>
<span class="n">SYSCALL_DEFINE0</span><span class="p">(</span><span class="n">hello_world</span><span class="p">)</span> 
<span class="p">{</span>
 <span class="n">printk</span><span class="p">(</span><span class="s">"Hello Ali. This is me, your custom system call.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="c1">// printk will print to the kernel log. do see the man page for more details</span>
 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>Create a <code class="language-plaintext highlighter-rouge">Makefile</code>inside your systems call directory and add the following line in it.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim Makefile
</code></pre></div></div>

<div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">obj-y</span> <span class="o">:=</span> hello_world.o
</code></pre></div></div>

<h2 id="step-2-adding-the-header">Step 2: Adding the header</h2>

<p>Till now we have designed our system call. Now we need to add and link this system call with our kernel.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim include/linux/syscalls.h

<span class="c"># add this line at the end of the file just above #endif</span>
asmlinkage long sys_hello_world <span class="o">(</span>void<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>We need to link our system call with the kernelâ€™s syscalls header. To do so add the following line at the end of <code class="language-plaintext highlighter-rouge">include/linux/syscalls.h</code></p>

<h2 id="step-3">Step 3</h2>

<p>Now we need to register our system call in the syscall table to get a unique system call number. For this open <code class="language-plaintext highlighter-rouge">arch/x86/entry/syscalls/syscall_64.tbl</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim <span class="nb">arch</span>/x86/entry/syscalls/syscall_64.tbl
</code></pre></div></div>

<p>Add the following entry at the end of the file where the last system call is registered.</p>

<aside>
ðŸ’¡ Remember, use a unique system call number in the 1st column of this table, and do not use the **reserved numbers**. Reserved numbers are already mentioned in this word table file.

</aside>

<p>For simplicity, I have used 696 number for my system call.</p>

<p><img src="/assets/images/posts/2022-04-13-Linux-Kernel-Compilation-imgs/6.png" alt="6.png" /></p>

<aside>
ðŸ’¡ In sir Arifâ€™s document, it was mentioned to add a prefix of _x64, but will create problems while compiling. Till now, I was unable to find the exact answer to this problem and why it would be an issue. ( if you find it, please let me know at my email address ;) bcsf19m513@pucit.edu.pk )

</aside>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">696</span> <span class="mi">64</span> <span class="n">hello_world</span> <span class="n">sys_hello_world</span>
</code></pre></div></div>

<h2 id="step-4">Step 4</h2>

<p>Now we need to add our system callâ€™s directory in the kernel source <code class="language-plaintext highlighter-rouge">Makefile</code>.</p>

<p>Open the <code class="language-plaintext highlighter-rouge">Makefile</code> and search for the <code class="language-plaintext highlighter-rouge">core-y</code> entry.</p>

<p>At the end of this line, add the system callâ€™s directory after a space and a <code class="language-plaintext highlighter-rouge">/</code> at the end of the line. For simplicity see the following picture.</p>

<p><img src="/assets/images/posts/2022-04-13-Linux-Kernel-Compilation-imgs/7.png" alt="7.png" /></p>

<div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">core-y</span> <span class="o">+=</span> kernel/ certs/ mm/ fs/ ipc/ security/ crypto/ block/ my_syscall/
</code></pre></div></div>

<h2 id="step-5">Step 5</h2>

<p>Now we need to recompile and install our kernel in order to test this system call.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make <span class="nt">-j</span> <span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span>
<span class="nb">sudo </span>make <span class="nb">install</span>
</code></pre></div></div>

<p>Use the following command to reboot and hold the shift key to select your custom kernel.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl reboot
</code></pre></div></div>

<aside>
ðŸ’¡ Remember, this time youâ€™ll find a .old kernel file in the grub boot loader but donâ€™t boot from it boot from your custom kernel.

</aside>

<h2 id="step-6">Step 6</h2>

<p>Now itâ€™s time to test you changes that you have made with your own kernel release i.e, testing system call.</p>

<aside>
ðŸ’¡ But remember you must be booted from your own new kernel release. You can verify your kernel that is running by using `uname -r` command.

</aside>

<p>Write a driver program anywhere in the system and test your system call.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/syscall.h&gt;
</span>
<span class="kt">int</span>
<span class="nf">main</span><span class="p">(){</span>
 <span class="kt">long</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">(</span><span class="mi">696</span><span class="p">);</span> <span class="c1">// 696 is my system call's number</span>
 <span class="k">if</span><span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span> <span class="c1">// it means no system call found with provided syscll number</span>
 <span class="n">printf</span><span class="p">(</span><span class="s">"error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Since I have used <code class="language-plaintext highlighter-rouge">printk</code> to write output on the kernel log file, so it wonâ€™t be printed on the shell/terminal. To check the kernel log, use <code class="language-plaintext highlighter-rouge">dmesg</code> and bound it to see the last entries after running the driver program. Youâ€™ll find your system callâ€™s output. Which means your system call is working.</p>

<p>Yes, you did it.</p>

<p><img src="/assets/images/posts/2022-04-13-Linux-Kernel-Compilation-imgs/8.jpeg" alt="8.jpeg" /></p>

<h1 id="writing-a-wrapper-function">Writing a wrapper function</h1>

<p>Till we successfully added and tested our system call on our custom kernel release. Now we need to write a wrapper function for our system call. One of the advantages of doing so is that we do not need to remember the syscall number in <code class="language-plaintext highlighter-rouge">syscall</code>.</p>

<h2 id="step-1-write-a-wrapper-function-in-c-file">Step 1: Write a wrapper function in <code class="language-plaintext highlighter-rouge">c</code> file</h2>

<p>You need to create a c file and then write a wrapper function in that file. I have created <code class="language-plaintext highlighter-rouge">greetings.c</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/syscall.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#define SYSCALLNO 696
</span>
<span class="kt">int</span> <span class="nf">hello</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">){</span>
 <span class="n">printf</span><span class="p">(</span><span class="s">"Hello %s!</span><span class="se">\n</span><span class="s">Your message is displayed on kernel log.</span><span class="se">\n</span><span class="s">You can use dmesg to read it.</span><span class="se">\n\n</span><span class="s">Thanks me later.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">name</span><span class="p">);</span>
 <span class="kt">long</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">(</span><span class="n">SYSCALLNO</span><span class="p">);</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
 <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"Error: Syacal Not found :(</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, here I have a recommendation that you can create a position-independent code (PIC) and create a dynamic library.</p>

<p>for that you need to compile your code using the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc <span class="nt">-c</span> <span class="nt">-fPIC</span> greetings.c
</code></pre></div></div>

<p>Now create a dynamic library with famous command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc <span class="nt">-shared</span> greetings.o <span class="nt">-o</span> libgreetings.so
</code></pre></div></div>

<p>Now you have <code class="language-plaintext highlighter-rouge">libgreetings.so</code> dynamic library. You can add this library to <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> using:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cp </span>libgreetings.so /usr/lib
</code></pre></div></div>

<p>So far so good. Now you can write a driver program to test your wrapper function.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
 <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
 <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">);</span>
 <span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">hello</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
 <span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And compile this code using:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc driver.c <span class="nt">-o</span> driver <span class="nt">-lgreetings</span>
</code></pre></div></div>

<p>And you are done.</p>

<h1 id="writing-the-man-page">Writing the man page</h1>

<p>Till now you can feel like <strong><em>ohh yee I have my own systemcall that seems something professional</em></strong>. But you have missed one thing while system call development.</p>

<p>To write a man page you must have a fair idea related to the chapter of the man pages. Since system calls reside in chapter 2 so you need to place a manual for your system call in <code class="language-plaintext highlighter-rouge">/usr/share/man/man2</code> which is the directory for chapter 2 man pages for system calls.</p>

<p>The file name should be something like <code class="language-plaintext highlighter-rouge">functionName.2</code> , and in my case, it would be <code class="language-plaintext highlighter-rouge">greetings.2</code>.</p>

<p>Then place your manual page entries like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\" This is the manual page for a custom system call .\"
.TH GREETINGS 2 "August 2022" "Linux Programmer's Manual"
.SH NAME
 greetings \- Prints a greeting message on kernel buffer.
.SH SYNOPSIS
.br
.sp
.BI int ("void");
.SH DESCRIPTION
This system call is written by Ali Raza to solve this assignment of System Programming at PUCIT.
It simply prints a greeting message from a 
.SH "RETURN VALUE"
return 0 on success or -1 on failure.
.SH "MESSAGE"
To be honest, systems are awesome. Try to do some productive stuff by adding or updating things in the kernel.
Happy Learning with "Dr. Arif Butt"!
</code></pre></div></div>

<p>The last thing is to zip this file using the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">gzip </span>greetings.2
</code></pre></div></div>

<p>Now your man page is ready. Since the <code class="language-plaintext highlighter-rouge">man</code> utility reads from <code class="language-plaintext highlighter-rouge">/usr/share/man</code> directory for man pages, you also need to place it in this directory under the correct chapter. (For our case it would be chapter 2, the system callâ€™s man pages).</p>

<p>So, to do that,</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cp </span>greetings.gz /usr/share/man/man2/
</code></pre></div></div>

<p>Now try <code class="language-plaintext highlighter-rouge">man greetings</code> and youâ€™ll find your man page.</p>

<p>And itâ€™s DONE.</p>

<p>I hope it was an informative tutorial.</p>

<p>Happy Learning and of course:</p>

<blockquote>
  <p>Learning Linux is fun with <a href="http://www.arifbutt.me/">Dr. Arif Butt ;)</a></p>

</blockquote>

<p>~Ali Raza Mumtaz (arm)</p>



  <small>tags: <em>Linux Kernel</em> - <em>Adding Systemcall</em> - <em>Writing man page</em></small>


      </section>
<script
  async
  src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9885194547171466"
  crossorigin="anonymous"
></script>
<ins
  class="adsbygoogle"
  style="display: block"
  data-ad-format="autorelaxed"
  data-ad-client="ca-pub-9885194547171466"
  data-ad-slot="5943869304"
></ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </div>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HSTC4ENYHY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-HSTC4ENYHY');
</script>
  </body>
</html>
